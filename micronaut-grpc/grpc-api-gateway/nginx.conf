events{}

http {

    include /etc/nginx/mime.types;

    log_format upstream_time '"$time_local" client=$remote_addr '
                   'method=$request_method request="$request" '
                   'request_length=$request_length '
                   'status=$status bytes_sent=$bytes_sent '
                   'body_bytes_sent=$body_bytes_sent '
                   'referer="$http_referer" '
                   'user_agent="$http_user_agent" '
                   'upstream_addr=$upstream_addr '
                   'upstream_status=$upstream_status '
                   'request_time=$request_time '
                   'upstream_response_time=$upstream_response_time '
                   'upstream_connect_time=$upstream_connect_time '
                   'upstream_header_time=$upstream_header_time';

    server {
        listen 80 http2;
        server_name localhost;

        # use internal docker resolver
        resolver 127.0.0.11;

        access_log /dev/stdout upstream_time;

        proxy_set_header Host            $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto https;

        location /pl.jcw.example.grpc.StockDataService {
            # Replace localhost:50051 with the address and port of your gRPC server
            # The 'grpc://' prefix is optional; unencrypted gRPC is the default
            # STOCK_DATA_HUB_ADDRESS is substituted by entrypoint.sh to env variable value
            set $upstreamName ${STOCK_DATA_HUB_ADDRESS};
            grpc_pass grpc://$upstreamName;
        }

        resolver_timeout 5s;
    }
}
